# Coinfloor Authentication Process

## User to Web Layer

Users authenticate to the web layer by sending a username and passphrase in an HTTP POST over SSL. The user is assured of the identity of the server due to its SSL certificate's having been signed by a trusted third party. The server is assured of the identity of the user since there is the assumption that only the legitimate account owner knows the username and passphrase combination.

## Web Layer (and bots) to Proxy Layer

The Web Layer and user bots authenticate to the proxy layer by sending an authentication message containing a numeric user identifier, a cookie (described as an API key on the Coinfloor website), a nonce chosen by the client, and a signature. The signature is generated from the user identifier, a nonce chosen by the proxy server (which is transmitted to the client upon its connecting to the server), and the client nonce. The connection is secured using SSL. The client is assured of the identity of the server due to its SSL certificate's having been signed by a trusted third party. The server is assured of the identity of the client since there is the assumption that only the web application and the legitimate account owner know the private key necessary to generate a valid signature.

![Proxy Authentication Process](/images/proxy_auth.png)

### Protocol

All communications with the Proxy Layer by clients are via the [WebSocket][IETF RFC 6455] protocol, version 13. WebSocket is a bidirectional, message-oriented protocol. The messages sent and received by the Proxy Layer are in [JSON][IETF RFC 4627] format. See the [API documentation][API] for the supported message types.

Authentication with the Proxy Layer is by a `Welcome` notification sent to the client and an `Authenticate` command sent by the client.

* The `Welcome` notification contains a `nonce` field, whose value is a base64-encoded nonce that has been randomly generated by the proxy server. The nonce is 16 bytes, and the base64 encoding transforms it into a 24-character string. This 16-byte nonce is hereafter referenced as the *server nonce*.
* The `Authenticate` command contains the following fields:
	* `user_id`: **Integer**. The unique identifier of the authenticating user.
	* `cookie`: **String**. A base64-encoded SHA-1 hash of the concatenation of the 16-byte cookie secret and the 8-byte (big-endian) user identifier. Note that this value varies by user but is fixed for each specific user. The cookie secret is private information within Coinfloor and must never be revealed to anyone. The cookie for each user should be revealed to that user only, as the user will need his or her specific cookie when authenticating. In the Coinfloor web interface, this authentication cookie is called an "API Key."
	* `nonce`: **String**. A base64-encoded nonce that has been randomly generated by the client. The nonce is 16 bytes, and the base64 encoding transforms it into a 24-character string. This 16-byte nonce is hereafter referenced as the *client nonce*.
	* `signature`: [ **String**, **String** ]. The base64-encoded *r* and *s* values of an [ECDSA][] signature over the SHA-224 digest of a message consisting of the concatenation of the 8-byte (big-endian) user identifier, the 16-byte server nonce, and the 16-byte client nonce. The signature uses the **secp224k1** curve parameters published by the [Standards for Efficient Cryptography Group][SECG] in [SEC 2: Recommended Elliptic Curve Domain Parameters version 2.0][SEC2] ([mirror][SEC2-mirror]). The private key used in signing is the 224-bit (big-endian) integer interpretation of the SHA-224 hash of the concatenation of the 8-byte (big-endian) user identifier and the UTF-8-encoded passphrase of the user.

#### Example

Suppose a client whose user identifier is 1 and whose passphrase is "opensesame" wishes to authenticate to the Proxy Layer.

1. The client connects to a proxy server and performs the WebSocket handshake.

1. The server sends a `Welcome` notification:

	```json
	{
		"notice": "Welcome",
		"nonce": "azRzAi5rm1ry/l0drnz1vw=="
	}
	```

1. The client decodes the server nonce into these 16 bytes:

		0x6b347302 2e6b9b5a f2fe5d1d ae7cf5bf

	(N.B: Spaces are shown for the sake of clarity and do not denote elements of the actual value.)

1. The client randomly generates a 16-byte client nonce:

		0xf08c98ca f1fd82e8 cea9825d bff04fd0

1. The client encodes the client nonce using base64:

		8IyYyvH9gujOqYJdv/BP0A==

1. The client's cookie is these 20 bytes:

		0x1c6444a9 c20b4f3f 1b9476bf 8ec51355 33412658

1. The client encodes its cookie using base64:

		HGREqcILTz8blHa/jsUTVTNBJlg=

1. The client constructs a 40-byte message to sign, consisting of its user identifier, the server nonce, and the client nonce:

		0x00000000 00000001
		0x6b347302 2e6b9b5a f2fe5d1d ae7cf5bf
		0xf08c98ca f1fd82e8 cea9825d bff04fd0

1. The client constructs a seed for its private key, consisting of its user identifier and UTF-8-encoded passphrase:

		0x00000000 00000001
		0x6f70656e 73657361 6d65

1. The client hashes its seed using SHA-224 to obtain its private key:

		0xb89ea7fc d22cc059 c2673dc2 4ff40b97 83074646 86560d0a d7561b83

1. The client [signs][ECDSA] the 28-byte SHA-224 digest of the 40-byte message using its private key under **secp224k1** and obtains, for example:

		r = 0x3fb77a9d 7b5b2a68 209e76f6 872078c5 791340d5 989854ad a3ab735e
		s = 0x34b84341 2f18a910 f18a7d4c e1d35978 60e6345b 22bf7894 cf67780a

	The [sign_secp224k1][] utility may be used to produce the signature.

1. The client encodes the signature using base64:

		P7d6nXtbKmggnnb2hyB4xXkTQNWYmFSto6tzXg==
		NLhDQS8YqRDxin1M4dNZeGDmNFsiv3iUz2d4Cg==

1. The client sends an `Authenticate` command to the server:

	```json
	{
		"method": "Authenticate",
		"user_id": 1,
		"cookie": "HGREqcILTz8blHa/jsUTVTNBJlg=",
		"nonce": "8IyYyvH9gujOqYJdv/BP0A==",
		"signature": [
			"P7d6nXtbKmggnnb2hyB4xXkTQNWYmFSto6tzXg==",
			"NLhDQS8YqRDxin1M4dNZeGDmNFsiv3iUz2d4Cg=="
		]
	}
	```

1. The server verifies the cookie and signature and returns a success response:

	```json
	{
		"error_code": 0
	}
	```


[API]: https://github.com/coinfloor/API/blob/master/WEBSOCKET-README.md
[ECDSA]: http://en.wikipedia.org/wiki/Elliptic_Curve_DSA
[IETF RFC 4627]: https://tools.ietf.org/html/rfc4627
[IETF RFC 6455]: https://tools.ietf.org/html/rfc6455
[SECG]: http://www.secg.org/
[SEC2]: http://www.secg.org/download/aid-784/sec2-v2.pdf
[SEC2-mirror]: http://www.shield-kratos.com/pdf/sec2-v2.pdf
[sign_secp224k1]: https://github.com/coinfloor/libecp#sign_secp224k1
